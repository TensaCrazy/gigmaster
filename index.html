<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIGMASTER PRO</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --green:#1db954;
  --bg:#0b0b0b;
  --surface:#141414;
  --border:#2a2a2a;
  --text:#fff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  border-bottom:1px solid var(--border);
}
main{
  flex:1;
  display:flex;
  overflow:hidden;
}
aside{
  width:280px;
  border-right:1px solid var(--border);
  padding:15px;
  overflow:auto;
}
section{
  flex:1;
  padding:15px;
  overflow:auto;
}
button{
  cursor:pointer;
  border:none;
  border-radius:10px;
}
.btn{
  background:var(--green);
  color:#fff;
  padding:12px;
  font-weight:600;
  width:100%;
}
.playlist{
  padding:12px;
  border-radius:10px;
  background:#1b1b1b;
  margin-bottom:8px;
}
.playlist.active{
  background:var(--green);
}
.song{
  padding:12px;
  border-bottom:1px solid var(--border);
}
footer{
  height:130px;
  border-top:1px solid var(--border);
  padding:15px;
}
.controls{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:20px;
}
input[type=range]{
  width:100%;
}
@media(max-width:768px){
  aside{display:none}
}
</style>
</head>

<body>

<header>GIGMASTER <span style="color:var(--green)">PRO</span></header>

<main>
  <aside>
    <button class="btn" onclick="addPlaylist()">+ NOVA PLAYLIST</button>
    <div id="playlists"></div>
  </aside>

  <section>
    <h2 id="pl-title">Biblioteca</h2>
    <input type="file" id="upload" hidden>
    <button class="btn" onclick="document.getElementById('upload').click()">+ MP3</button>
    <div id="songs"></div>
  </section>
</main>

<footer>
  <div id="now">Standby</div>
  <input type="range" id="seek" min="0" step="0.01">
  <div class="controls">
    <button onclick="togglePlay()">▶ / ❚❚</button>
  </div>
</footer>

<script>
/* ===== SUPABASE ===== */
const SB_URL = "https://mdtqwugkaonipbfqqvhj.supabase.co";
const SB_KEY = "sb_publishable_ercRd8vFjpnVyXf0WiPVSw_tWCSmsGm";
const sb = supabase.createClient(SB_URL, SB_KEY);

/* ===== ESTADO ===== */
let currentPlaylist = null;
let currentSong = null;
let offset = 0;
let lastStart = 0;
let audioReady = false;

/* ===== PLAYER ===== */
const player = new Tone.Player({autostart:false});
const pitch = new Tone.PitchShift(0);
player.chain(pitch, Tone.Destination);

async function initAudio(){
  if(!audioReady){
    await Tone.start();
    audioReady = true;
  }
}

/* ===== PLAY / PAUSE ===== */
function togglePlay(){
  if(!player.buffer || !player.buffer.loaded) return;
  initAudio();

  if(player.state === "started"){
    player.stop();
    offset += Tone.now() - lastStart;
  }else{
    lastStart = Tone.now();
    player.start(0, offset);
  }
}

/* ===== SEEK ===== */
const seek = document.getElementById("seek");
seek.onchange = ()=>{
  if(!player.buffer) return;
  offset = parseFloat(seek.value);
  if(player.state === "started"){
    lastStart = Tone.now();
    player.start(0, offset);
  }
};
setInterval(()=>{
  if(player.state === "started"){
    seek.value = offset + (Tone.now() - lastStart);
  }
},100);

/* ===== LOAD PLAYLISTS ===== */
async function loadPlaylists(){
  const {data:{user}} = await sb.auth.getUser();
  if(!user) return;

  const {data} = await sb.from("playlists")
    .select("*")
    .eq("user_id",user.id)
    .order("nome");

  document.getElementById("playlists").innerHTML =
    data.map(p=>`
      <div class="playlist ${currentPlaylist===p.id?'active':''}"
        onclick="selectPlaylist(${p.id},'${p.nome}')">
        ${p.nome}
      </div>
    `).join("");
}

/* ===== ADD PLAYLIST ===== */
async function addPlaylist(){
  const name = prompt("Nome da playlist:");
  if(!name) return;

  const {data:{user}} = await sb.auth.getUser();
  if(!user) return alert("Faça login");

  await sb.from("playlists").insert([{nome:name,user_id:user.id}]);
  loadPlaylists();
}

/* ===== SELECT PLAYLIST ===== */
async function selectPlaylist(id,name){
  currentPlaylist = id;
  document.getElementById("pl-title").innerText = name;
  loadPlaylists();
  loadSongs();
}

/* ===== LOAD SONGS ===== */
async function loadSongs(){
  const {data} = await sb.from("musicas")
    .select("*")
    .eq("playlist_id",currentPlaylist)
    .order("titulo");

  document.getElementById("songs").innerHTML =
    data.map(s=>`
      <div class="song" onclick="playSong('${s.audio_url}','${s.titulo}')">
        ${s.titulo}
      </div>
    `).join("");
}

/* ===== PLAY SONG ===== */
async function playSong(url,title){
  initAudio();
  offset = 0;
  player.stop();
  player.buffer?.dispose();

  player.buffer = await new Tone.ToneAudioBuffer(url);
  lastStart = Tone.now();
  player.start();
  document.getElementById("now").innerText = title;
  seek.max = player.buffer.duration;
}

/* ===== UPLOAD ===== */
document.getElementById("upload").onchange = async e=>{
  const f = e.target.files[0];
  if(!f || !currentPlaylist) return;

  const path = `audios/${Date.now()}_${f.name}`;
  await sb.storage.from("audios").upload(path,f);
  const {data:{publicUrl}} = sb.storage.from("audios").getPublicUrl(path);

  await sb.from("musicas").insert([{
    titulo:f.name,
    audio_url:publicUrl,
    playlist_id:currentPlaylist,
    pitch:0
  }]);

  loadSongs();
};

/* ===== INIT ===== */
loadPlaylists();
</script>

</body>
</html>

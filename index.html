
 <!DOCTYPE html>
 <html lang="pt-br">
 <head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>GIGMASTER PRO | v29.9</title>
 
 <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
 
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
 
 <style>
 :root{--green:#1db954;--bg:#0b0b0b;--surface:#141414;--border:#2a2a2a;--text:#fff}
 body.light{--green:#e91e63;--bg:#e0e0e0;--surface:#f5f5f5;--border:#ccc;--text:#111}
 *{box-sizing:border-box}
 body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
 
 /* LOGIN */
 #auth{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999}
 .auth-box{width:320px;text-align:center}
 .auth-box input{width:100%;padding:14px;margin-bottom:10px;border-radius:10px;background:#111;border:1px solid #333;color:#fff}
 
 /* APP */
 #app{display:none;flex-direction:column;height:100vh}
 header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:var(--surface);border-bottom:1px solid var(--border)}
 
 .u-badge{background:var(--border);padding:6px 14px;border-radius:20px;font-size:11px;cursor:pointer;position:relative}
 .drop-menu{display:none;position:absolute;top:45px;right:0;width:200px;background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;z-index:600}
 .drop-menu div{padding:14px 18px;font-size:11px;border-bottom:1px solid var(--border);cursor:pointer}
 
 main{flex:1;display:flex;overflow:hidden}
 aside{width:280px;border-right:1px solid var(--border);padding:15px;overflow-y:auto;background:var(--bg)}
 section{flex:1;padding:20px;overflow-y:auto}
 
 button{cursor:pointer;border:none;border-radius:10px}
 .btn{background:var(--green);color:#fff;padding:12px;font-weight:600;width:100%;margin-bottom:12px}
 
 .playlist{padding:12px;border-radius:10px;background:#1b1b1b;margin-bottom:8px;cursor:pointer;border:1px solid transparent}
 .playlist.active{background:var(--green);border-color:rgba(255,255,255,0.2)}
 .pl-tools{display:flex;gap:12px;margin-top:8px;font-size:10px;opacity:.7;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px}
 
 .song{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;cursor:pointer}
 
 footer{height:140px;border-top:1px solid var(--border);padding:15px;background:var(--surface)}
 .controls{display:flex;justify-content:center;gap:20px;margin-top:10px}
 .slider-box{display:flex;align-items:center;gap:8px;font-size:12px}
 
 #toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--green);padding:10px 20px;border-radius:20px;display:none;z-index:99999}
 .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items:center; justify-content:center; backdrop-filter: blur(8px); }
 
 @media(max-width:768px){aside{display:none}}
 </style>
 </head>
 <body onclick="Tone.start()">
 
 <div id="toast"></div>
 
 <div id="auth">
   <div class="auth-box">
    <h2 style="color:var(--green);letter-spacing:4px">GIGMASTER</h2>
    <input id="email" type="email" placeholder="E-mail">
    <input id="pass" type="password" placeholder="Senha">
    <button id="btn-login" class="btn">ENTRAR</button>
    <button id="btn-google" class="btn" style="background:#4285F4">GOOGLE</button>
    <p id="btn-signup" style="font-size:11px;color:#777;cursor:pointer">Criar conta</p>
   </div>
 </div>
 
 <div id="modal-pix" class="modal-overlay" onclick="closeM('modal-pix')">
   <div class="modal-box" style="background:var(--surface);padding:30px;border-radius:24px;text-align:center;" onclick="event.stopPropagation()">
     <h3 style="margin-top:0">APOIAR VIA PIX</h3>
     <img src="pix.jpg" style="width:100%; border-radius:15px; margin:10px 0;">
     <button class="btn" onclick="closeM('modal-pix')">FECHAR</button>
   </div>
 </div>
 
 <div id="app">
 <header>
   <div>GIGMASTER <span style="color:var(--green)">PRO</span></div>
   <div class="u-badge" onclick="toggleMenu()">
     <span id="u-display">PERFIL</span> ‚ñº
     <div class="drop-menu" id="u-drop">
       <div id="btn-theme">üåì TEMA</div>
       <div id="btn-rename-nick">üë§ NICKNAME</div>
       <div onclick="toast('Bug relatado!')">üêû RELATAR BUG</div>
       <div id="btn-pix">üíé APOIAR PIX</div>
       <div id="btn-logout" style="color:#ff4d4d">üö™ SAIR</div>
     </div>
   </div>
 </header>
 
 <main>
 <aside>
  <button id="add-pl-btn" class="btn">+ NOVA PASTA</button>
   <div id="playlist-container"></div>
 </aside>
 <section>
   <h2 id="pl-title">Biblioteca</h2>
   <input type="file" id="upload" hidden accept="audio/mp3">
  <button class="btn" id="btn-up" style="display:none;width:200px">IMPORTAR MP3</button>
   <div id="songs-container"></div>
 </section>
 </main>
 
 <footer>
 <div id="now" style="text-align:center;font-size:12px;color:var(--green)">Standby</div>
 <input type="range" id="seek" min="0" step="0.01" value="0" style="width:100%">
 <div class="controls">
   <div class="slider-box">
     <span>PITCH</span>
     <input id="p-slide" type="range" min="-7" max="7" value="0">
     <b id="p-val">0</b>
   </div>
  <button id="play-btn" style="width:50px;height:50px;border-radius:50%;background:#fff;color:#000;font-size:20px">‚ñ∂</button>
   <div class="slider-box">
     <span>VOL</span>
     <input id="v-slide" type="range" min="-40" max="6" value="0">
   </div>
 </div>
 </footer>
 </div>
 
 <script>
 const sb = supabase.createClient("https://mdtqwugkaonipbfqqvhj.supabase.co", "sb_publishable_ercRd8vFjpnVyXf0WiPVSw_tWCSmsGm");
 
 const player=new Tone.Player();
 const pitchNode=new Tone.PitchShift(0).toDestination();
// DOM handles (avoid relying on global id-to-variable mapping)
const uploadEl = document.getElementById("upload");
const seekEl = document.getElementById("seek");
const pSlideEl = document.getElementById("p-slide");
const pValEl = document.getElementById("p-val");
const vSlideEl = document.getElementById("v-slide");
const playBtnEl = document.getElementById("play-btn");

 let offset=0, lastStart=0, dragging=false, curPl=null;
 
 /* AUTH */
 async function handleAuth(type){
  const email=document.getElementById("email").value;
  const pass=document.getElementById("pass").value;
  try{
    let resp;
    if(type === 'in'){
      resp = await sb.auth.signInWithPassword({ email, password: pass });
    } else {
      resp = await sb.auth.signUp({ email, password: pass });
    }
    if(resp.error) throw resp.error;
  }catch(err){
    alert(err.message || String(err));
  }
 }
 async function loginGoogle(){ await sb.auth.signInWithOAuth({ provider:"google", options:{ redirectTo: window.location.origin + window.location.pathname } }); }
 async function logout(){ await sb.auth.signOut(); location.reload(); }
 
 /* CARREGAMENTO ROBUSTO */
 sb.auth.onAuthStateChange(async (e,session)=>{
   if(session){
     document.getElementById("auth").style.display="none";
     document.getElementById("app").style.display="flex";
     
     // Pegar Perfil
     const {data:prof} = await sb.from('profiles').select('username').eq('id', session.user.id).single();
     document.getElementById("u-display").innerText = (prof?.username || session.user.email.split("@")[0]).toUpperCase();
     
     // Tenta carregar playlists 3 vezes se falhar
    // If the page has a shared query param, open it first
    const urlParams = new URLSearchParams(window.location.search);
    const shared = urlParams.get('shared');
    if(shared){
      // attempt to load shared playlist (may require public DB permissions)
      await loadSharedPlaylist(shared);
    }

    let tentativas = 0;
    const interval = setInterval(async () => {
        const ok = await loadPlaylists();
        tentativas++;
        if(ok || tentativas > 3) clearInterval(interval);
    }, 500);
 
   } else {
     document.getElementById("auth").style.display="flex";
     document.getElementById("app").style.display="none";
   }
 });

async function loadSharedPlaylist(id){
  try{
    const { data, error } = await sb.from('playlists').select('*').eq('id', id).single();
    if(error || !data){ toast('Playlist compartilhada n√£o encontrada'); return; }
    curPl = data.id;
    document.getElementById('pl-title').innerText = data.nome;
    document.getElementById('btn-up').style.display = 'block';
    await loadSongs();
    // highlight in list if possible
    await loadPlaylists();
  }catch(e){ console.error(e); toast('Erro ao abrir playlist compartilhada'); }
}
 
 /* PLAYLISTS */
async function loadPlaylists(){
  const gu = await sb.auth.getUser();
  const user = gu?.data?.user;
  if(!user) return false;

  const {data, error} = await sb.from("playlists").select("*").eq("user_id", user.id).order("nome", { ascending: true });
  if(error) { console.error('loadPlaylists error', error); return false; }

  const container = document.getElementById("playlist-container");
  console.log('loadPlaylists auth.getUser result:', gu);
  console.log('loadPlaylists user id:', user?.id);
  console.log('loadPlaylists fetched playlists count:', (data||[]).length);
  if(!(data||[]).length){
    container.innerHTML = '<div style="opacity:.6;padding:8px">Nenhuma playlist</div>';
    return true;
  }
  container.innerHTML = (data || []).map(p => {
    const encName = encodeURIComponent(p.nome);
    const active = (curPl == p.id) ? 'active' : '';
    return `
      <div class="playlist ${active}" data-id="${p.id}" data-name="${encName}">
        <b>${p.nome.toUpperCase()}</b>
        <div class="pl-tools">
          <span data-action="zip" data-id="${p.id}" data-name="${encName}">üì¶ ZIP</span>
          <span data-action="rename" data-id="${p.id}" data-name="${encName}">‚úé RENOMEAR</span>
          <span data-action="share" data-id="${p.id}">üîó COMPARTILHAR</span>
          <span data-action="delete" data-id="${p.id}">üóëÔ∏è EXCLUIR</span>
        </div>
      </div>`;
  }).join("");
  return true;
}

async function renamePlaylist(id, oldName){
  const decoded = decodeURIComponent(String(oldName || ''));
  const n = prompt('Novo nome:', decoded);
  if(!n) return;
  await sb.from('playlists').update({ nome: n }).eq('id', id);
  loadPlaylists();
  if(curPl === id) document.getElementById('pl-title').innerText = n;
  toast('Renomeado');
}

async function sharePlaylist(id){
  const url = new URL(window.location.href);
  url.searchParams.set('shared', id);
  const shareUrl = url.toString();
  try{ await navigator.clipboard.writeText(shareUrl); toast('Link copiado!'); }
  catch(e){ prompt('Copie o link abaixo:', shareUrl); }
}
 
 /* AUDIO & SONGS */
 function routeAudio(p){ player.disconnect(); p==0?player.toDestination():(pitchNode.pitch=p,player.connect(pitchNode)); }
 
async function playSong(url,t,p){
  document.getElementById("now").innerText="CARREGANDO...";
 try{
    await Tone.start();
    player.stop();
    // Use Player.load which handles buffering and is simpler
    await player.load(url);
    routeAudio(p);
    offset = 0;
    lastStart = Tone.now();
    if(pSlideEl) { pSlideEl.value = p; }
    if(pValEl) { pValEl.innerText = p; }
    if(seekEl && player.buffer) { seekEl.max = player.buffer.duration; }
    player.start();
    if(playBtnEl) playBtnEl.innerText = "‚ùö‚ùö";
    document.getElementById("now").innerText = t;
  }catch(err){
    console.error('playSong error', err);
    toast('Erro ao carregar √°udio');
  }
 }
 
async function togglePlay(){
  if(!player.buffer?.loaded)return;
  await Tone.start();
  if(player.state==="started"){
    offset+=Tone.now()-lastStart; player.stop();
    document.getElementById("play-btn").innerText="‚ñ∂";
  }else{
    lastStart=Tone.now(); player.start(0,offset);
    document.getElementById("play-btn").innerText="‚ùö‚ùö";
  }
}
 
 const sk=document.getElementById("seek");
 sk.onmousedown = sk.ontouchstart = () => dragging=true;
 sk.onchange = e => {
     dragging=false; offset=parseFloat(e.target.value);
     if(player.state==="started"){ lastStart=Tone.now(); player.start(0, offset); }
 };
 setInterval(()=>{ if(player.state==="started" && !dragging) sk.value=offset+(Tone.now()-lastStart); }, 100);
 
if(pSlideEl) pSlideEl.oninput = e => { routeAudio(parseInt(e.target.value)); if(pValEl) pValEl.innerText = e.target.value; };
if(vSlideEl) vSlideEl.oninput = e => Tone.Destination.volume.value = parseFloat(e.target.value);
 
 async function selectPlaylist(id,n){ curPl=id; document.getElementById("pl-title").innerText=n; document.getElementById("btn-up").style.display="block"; loadSongs(); loadPlaylists(); }
 
 async function loadSongs(){
   const {data}=await sb.from("musicas").select("*").eq("playlist_id",curPl).order("titulo");
  if(!(data||[]).length){
    document.getElementById('songs-container').innerHTML = '<div style="opacity:.6;padding:8px">Nenhuma m√∫sica</div>';
    return;
  }
  document.getElementById("songs-container").innerHTML=(data||[]).map(s => {
    const encTitle = encodeURIComponent(s.titulo);
    return `
    <div class="song" data-id="${s.id}" data-audio="${s.audio_url}" data-title="${encTitle}" data-pitch="${s.pitch}">
      <span>${s.titulo}</span>
      <div class="song-actions" style="display:flex; gap:15px;">
        <svg data-action="download" data-audio="${s.audio_url}" data-title="${encTitle}" viewBox="0 0 24 24" width="18" fill="currentColor" style="opacity:0.6"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        <span data-action="delete" data-id="${s.id}" style="opacity:.4">‚úï</span>
      </div>
    </div>`;
  }).join("");
 }
 
 /* MENUS & GEST√ÉO */
 function openM(id) { document.getElementById(id).style.display = 'flex'; }
 function closeM(id) { document.getElementById(id).style.display = 'none'; }
 function toggleMenu(){ const m=document.getElementById("u-drop"); m.style.display=m.style.display==="block"?"none":"block"; }
 function toggleTheme(){ document.body.classList.toggle("light") }
 function toast(t){ const x=document.getElementById("toast"); x.innerText=t; x.style.display="block"; setTimeout(()=>x.style.display="none",3000) }
 
 async function addPlaylist(){
   const n=prompt("Nome da pasta:"); if(!n)return;
  const {data:{user}}=await sb.auth.getUser();
  const { data, error } = await sb.from("playlists").insert([{nome:n,user_id:user.id}]).select().single();
  if(error){ toast('Erro ao criar pasta'); return; }
  await loadPlaylists();
  // select the newly created playlist
  if(data?.id) selectPlaylist(data.id, data.nome);
 }
 async function deletePlaylist(id){ if(confirm("Apagar pasta?")) { await sb.from("musicas").delete().eq("playlist_id",id); await sb.from("playlists").delete().eq("id",id); loadPlaylists(); } }
 async function deleteSong(id){ await sb.from("musicas").delete().eq("id",id); loadSongs(); }
 
 async function downloadDirect(url, filename) {
     const res = await fetch(url);
     const blob = await res.blob();
     const link = document.createElement("a");
     link.href = URL.createObjectURL(blob);
     link.download = filename;
     link.click();
 }
 
 async function downloadZip(id, name) {
     toast("üì¶ Gerando ZIP...");
     const { data } = await sb.from('musicas').select('*').eq('playlist_id', id);
     const zip = new JSZip();
     for (const s of data) {
         const res = await fetch(s.audio_url);
         zip.file(s.titulo, await res.blob());
     }
     const content = await zip.generateAsync({type:"blob"});
     const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = `${name}.zip`; a.click();
 }
 
 async function uiRenameNick() {
     const n = prompt("Novo Nickname:"); if(!n) return;
     const {data:{user}} = await sb.auth.getUser();
     await sb.from('profiles').upsert({id: user.id, username: n});
     document.getElementById("u-display").innerText = n.toUpperCase();
 }
 
if(uploadEl) uploadEl.onchange = async e => {
  const f = e.target.files[0]; if(!f) return;
   toast("‚è≥ Enviando...");
  const path = `audios/${Date.now()}_${f.name}`;
  await sb.storage.from("audios").upload(path, f);
  const { data } = sb.storage.from("audios").getPublicUrl(path);
  // getPublicUrl returns { data: { publicUrl } }
  const publicUrl = data?.publicUrl || data?.public_url || '';
  await sb.from("musicas").insert([{ titulo: f.name, audio_url: publicUrl, playlist_id: curPl, pitch: 0 }]);
   loadSongs(); toast("OK!");
 };

// Event delegation and static listeners
const playlistContainer = document.getElementById('playlist-container');
const songsContainer = document.getElementById('songs-container');
if(playlistContainer){
  playlistContainer.addEventListener('click', (ev)=>{
    const actionEl = ev.target.closest('[data-action]');
    if(actionEl){
      ev.stopPropagation();
      const action = actionEl.dataset.action;
      const id = actionEl.dataset.id;
      const name = actionEl.dataset.name ? decodeURIComponent(actionEl.dataset.name) : undefined;
      if(action==='zip') return downloadZip(id, name);
      if(action==='rename') return renamePlaylist(id, name);
      if(action==='share') return sharePlaylist(id);
      if(action==='delete') return deletePlaylist(id);
      return;
    }
    const pl = ev.target.closest('.playlist'); if(pl){ selectPlaylist(pl.dataset.id, decodeURIComponent(pl.dataset.name)); }
  });
}
if(songsContainer){
  songsContainer.addEventListener('click', (ev)=>{
    const actionEl = ev.target.closest('[data-action]');
    if(actionEl){
      ev.stopPropagation();
      const action = actionEl.dataset.action;
      if(action==='download') return downloadDirect(actionEl.dataset.audio, decodeURIComponent(actionEl.dataset.title || ''));
      if(action==='delete') return deleteSong(actionEl.dataset.id);
      return;
    }
    const song = ev.target.closest('.song'); if(song){ playSong(song.dataset.audio, decodeURIComponent(song.dataset.title||''), parseInt(song.dataset.pitch||0)); }
  });
}

// Static controls
const addPlBtn = document.getElementById('add-pl-btn'); if(addPlBtn) addPlBtn.addEventListener('click', addPlaylist);
const btnUp = document.getElementById('btn-up'); if(btnUp) btnUp.addEventListener('click', ()=> uploadEl.click());
const btnLogin = document.getElementById('btn-login'); if(btnLogin) btnLogin.addEventListener('click', ()=> handleAuth('in'));
const btnGoogle = document.getElementById('btn-google'); if(btnGoogle) btnGoogle.addEventListener('click', loginGoogle);
const btnSignup = document.getElementById('btn-signup'); if(btnSignup) btnSignup.addEventListener('click', ()=> handleAuth('up'));
if(playBtnEl) playBtnEl.addEventListener('click', togglePlay);
const btnTheme = document.getElementById('btn-theme'); if(btnTheme) btnTheme.addEventListener('click', toggleTheme);
const btnRenameNick = document.getElementById('btn-rename-nick'); if(btnRenameNick) btnRenameNick.addEventListener('click', uiRenameNick);
const btnPix = document.getElementById('btn-pix'); if(btnPix) btnPix.addEventListener('click', ()=> openM('modal-pix'));
const btnLogout = document.getElementById('btn-logout'); if(btnLogout) btnLogout.addEventListener('click', logout);
 </script>
 </body>
 </html>
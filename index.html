<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GIGMASTER | Studio Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root { --green: #1db954; --bg: #050505; --card: #121212; --border: #282828; --text: #ffffff; --dim: #b3b3b3; }
        body.light-mode { --bg: #f5f5f5; --card: #ffffff; --border: #ddd; --text: #111; --dim: #555; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        #auth-screen, #cifra-modal, #pix-modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); }
        #auth-screen { display: flex; z-index: 5000; } /* Garante que o login apare√ßa primeiro */
        
        .card-ui { background: var(--card); padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .card-ui input { width: 100%; padding: 12px; background: #181818; border: 1px solid var(--border); color: white; border-radius: 8px; outline: none; }
        .card-ui textarea { height: 350px; font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--green); background: #000; border: 1px solid var(--border); border-radius: 8px; padding: 10px; resize: none; outline: none; }

        #app { display: none; height: 100vh; flex-direction: column; }
        .main-header { padding: 10px 20px; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar { width: 280px; background: #000; padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 20px; transition: transform 0.3s ease; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; height: 100%; transform: translateX(-100%); width: 85%; z-index: 3000; }
            .sidebar.active { transform: translateX(0); box-shadow: 20px 0 50px rgba(0,0,0,0.8); }
        }

        #menu-toggle { display: none; background: none; border: 1px solid var(--border); color: #fff; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
        @media (max-width: 768px) { #menu-toggle { display: block; } }

        .content { flex: 1; overflow-y: auto; background: linear-gradient(to bottom, #1a1a1a, var(--bg)); padding-bottom: 150px; }
        #cifra-viewer { padding: 40px; font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; font-size: 16px; line-height: 1.7; display: none; max-width: 900px; margin: 0 auto; cursor: pointer; }
        .song-list-wrapper { padding: 30px; max-width: 900px; margin: 0 auto; }

        .song-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-radius: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.02); transition: 0.2s; border: 1px solid transparent; cursor: pointer; }
        .song-item.active-song { background: rgba(29, 185, 84, 0.1); border-color: var(--green); color: var(--green); font-weight: bold; }

        footer { background: #121212; border-top: 1px solid var(--border); padding: 15px 40px; position: fixed; bottom: 0; width: 100%; z-index: 2000; }
        .footer-content { display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto; gap: 30px; }
        .player-core { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .controls-row { display: flex; align-items: center; gap: 25px; }

        .play-btn { width: 56px; height: 56px; border-radius: 50%; background: #fff; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .play-btn svg { fill: #000; width: 24px; height: 24px; }
        input[type="range"] { accent-color: var(--green); cursor: pointer; }

        @media (max-width: 768px) {
            footer { padding: 10px 15px; }
            .footer-content { flex-direction: column; gap: 5px; }
            .track-info, .side-controls { display: none; }
            .controls-row { width: 100%; justify-content: space-between; }
        }

        .user-menu { position: relative; }
        .user-icon { width: 38px; height: 38px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--dim); }
        .user-dropdown { position: absolute; top: 45px; right: 0; background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 220px; display: none; flex-direction: column; z-index: 1000; }
        .user-dropdown.active { display: flex; }
        .dropdown-item { padding: 12px 15px; font-size: 13px; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text); display: flex; align-items: center; gap: 10px; }

        .btn-green { background: var(--green); border: none; padding: 10px 20px; border-radius: 30px; font-weight: 700; color: #000; cursor: pointer; font-size: 12px; }
        .btn-outline { background: transparent; border: 1px solid var(--dim); color: #fff; padding: 8px 16px; border-radius: 30px; font-size: 11px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card-ui">
            <h2 style="text-align:center; letter-spacing:-1px;">GIG<span>MASTER</span></h2>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Senha">
            <button class="btn-green" onclick="handleAuth()">ENTRAR</button>
            <p id="auth-error" style="color:#ff4444; font-size:10px; text-align:center; display:none;"></p>
        </div>
    </div>
    
    <div id="cifra-modal" style="display:none;"><div class="card-ui"><h3>üìù Editar Cifra</h3><textarea id="cifra-input"></textarea><div style="display:flex; gap:10px;"><button class="btn-outline" style="flex:1" onclick="closeCifra()">CANCELAR</button><button class="btn-green" style="flex:1" id="save-cifra-btn" onclick="saveCifra()">SALVAR</button></div></div></div>
    <div id="pix-modal" style="display:none;" onclick="closePix()"><div class="card-ui" style="background:white; color:black; text-align:center;"><h3>Apoie o GIGMASTER</h3><img src="pix.jpg" style="width:220px; margin:15px 0;"><button class="btn-green" style="width:100%" onclick="closePix()">FECHAR</button></div></div>

    <div id="app">
        <header class="main-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <button id="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <div style="font-weight:800; font-size:1.2rem; letter-spacing:-1px;">GIG<span>MASTER</span></div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <label class="btn-green" style="font-size:11px;">MP3<input type="file" id="file-input" accept="audio/*" style="display:none;"></label>
                <div class="user-menu">
                    <div class="user-icon" onclick="toggleUserMenu()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                    <div id="user-dropdown" class="user-dropdown">
                        <div class="dropdown-item" onclick="toggleTheme()">üåì Alternar Tema</div>
                        <div class="dropdown-item" onclick="shareCurrentPlaylist()">üîó Partilhar Playlist</div>
                        <div class="dropdown-item" onclick="openPixModal()">‚òï Doa√ß√£o (PIX)</div>
                        <div class="dropdown-item" style="color:#ff4444;" onclick="logout()">üö™ Sair</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar" id="sidebar">
                <button onclick="createNewPlaylist()" class="btn-outline" style="width:100%;">+ NOVA PASTA</button>
                <div id="playlist-list" style="overflow-y:auto; flex:1;"></div>
            </aside>
            <main class="content" id="main-content">
                <div id="cifra-viewer" onclick="closeCifraViewer()"></div>
                <div id="song-list-wrapper" class="song-list-wrapper">
                    <h1 id="view-title" style="margin-top:0; font-size:2rem;">Biblioteca</h1>
                    <div id="song-list"></div>
                </div>
            </main>
        </div>

        <footer>
            <div class="footer-content">
                <div class="track-info" style="width:250px">
                    <div id="track-name" style="font-weight:600; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Pronto</div>
                    <div style="font-size:0.7rem; color:var(--dim);">Studio Pro Mode</div>
                </div>
                <div class="player-core">
                    <div class="controls-row">
                        <div style="text-align: center;">
                            <span style="font-size: 9px; font-weight: 800; color: var(--dim);">TOM</span><br>
                            <b id="pitch-val" style="color:var(--green); font-size:14px;">0</b>
                            <input type="range" id="pitch-slider" min="-8" max="8" value="0" style="width:90px; display:block;">
                        </div>
                        <button id="play-btn" class="play-btn"><svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                        <div style="text-align: center;">
                            <span style="font-size: 9px; font-weight: 800; color: var(--dim);">VOL</span><br>
                            <input type="range" id="volume-slider" min="-60" max="0" value="-5" style="width:90px; display:block;">
                        </div>
                    </div>
                    <input type="range" id="seek-slider" value="0" step="0.01" style="width:100%; max-width:500px;">
                </div>
                <div class="side-controls"><button id="save-btn" onclick="uploadAndSave()" class="btn-green" style="font-size:10px;">SALVAR TOM</button></div>
            </div>
        </footer>
    </div>

<script>
    const SB_URL = 'https://mdtqwugkaonipbfqqvhj.supabase.co';
    const SB_KEY = 'sb_publishable_ercRd8vFjpnVyXf0WiPVSw_tWCSmsGm';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    const player = new Tone.Player();
    const pitchShift = new Tone.PitchShift({ pitch: 0, windowSize: 0.15, overlap: 0.05 }).toDestination();
    player.connect(pitchShift);
    player.sync().start(0);

    let currentPlaylistId, currentSongId, isGuest = false;

    // --- LOGIN & AUTH ---
    async function handleAuth() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        const errorEl = document.getElementById('auth-error');
        errorEl.style.display = 'none';
        
        const { error } = await supabaseClient.auth.signInWithPassword({email:e, password:p});
        if(error) {
            errorEl.innerText = "Erro: " + error.message;
            errorEl.style.display = 'block';
        } else { checkUser(); }
    }

    async function checkUser() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if(session) {
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('app').style.display='flex';
            loadPlaylists();
        } else {
            document.getElementById('auth-screen').style.display='flex';
        }
    }

    // --- DATA HANDLING ---
    async function loadPlaylists() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if(!user) return;
        const { data } = await supabaseClient.from('playlists').select('*').eq('user_id', user.id);
        document.getElementById('playlist-list').innerHTML = data.map(p => `
            <div class="song-item ${currentPlaylistId==p.id?'active-song':''}" style="padding:12px; background:transparent;" onclick="selectPlaylist(${p.id}, '${p.nome}')">
                <span>üìÇ ${p.nome}</span>
                <span onclick="event.stopPropagation(); deletePlaylist(${p.id})">‚úï</span>
            </div>
        `).join('');
    }

    async function playSong(song) {
        currentSongId = song.id; 
        document.getElementById('track-name').innerText = song.titulo;
        await player.load(song.audio_url);
        
        const viewer = document.getElementById('cifra-viewer');
        const wrapper = document.getElementById('song-list-wrapper');
        
        if(song.cifra && song.cifra.trim() !== "") {
            viewer.innerText = song.cifra;
            viewer.style.display = 'block';
            wrapper.style.display = 'none';
        } else {
            viewer.style.display = 'none';
            wrapper.style.display = 'block';
        }
        
        pitchShift.pitch = song.pitch;
        document.getElementById('pitch-val').innerText = song.pitch;
        document.getElementById('pitch-slider').value = song.pitch;
        document.getElementById('seek-slider').max = player.buffer.duration;
        loadSongs();
    }

    // --- UI UTILS ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function toggleUserMenu() { document.getElementById('user-dropdown').classList.toggle('active'); }
    function toggleTheme() { document.body.classList.toggle('light-mode'); }
    function logout() { supabaseClient.auth.signOut(); location.reload(); }
    function closeCifraViewer() { document.getElementById('cifra-viewer').style.display='none'; document.getElementById('song-list-wrapper').style.display='block'; }

    // --- PLAYER ---
    document.getElementById('play-btn').onclick = async () => {
        await Tone.start();
        if (Tone.Transport.state === "started") {
            Tone.Transport.pause(); document.getElementById('play-icon').innerHTML = '<path d="M8 5v14l11-7z"/>';
        } else if (player.buffer.loaded) {
            Tone.Transport.start(); document.getElementById('play-icon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        }
    };
    
    // In√≠cio
    checkUser();
    
    // Boilerplate de suporte
    async function loadSongs() { if(!currentPlaylistId) return; const { data } = await supabaseClient.from('musicas').select('*').eq('playlist_id', currentPlaylistId).order('id'); document.getElementById('song-list').innerHTML = data.map(s => `<div class="song-item ${currentSongId===s.id?'active-song':''}" onclick='playSong(${JSON.stringify(s)})'><span>${s.titulo}</span><div style="display:flex; gap:15px; font-size:1.1rem;"><span onclick="event.stopPropagation(); editCifra(${s.id}, \`${s.cifra || ""}\`)">üìÑ</span>${!isGuest ? `<span onclick="event.stopPropagation(); deleteSong(${s.id})">‚úï</span>` : ''}</div></div>`).join(''); }
    function selectPlaylist(id, n) { currentPlaylistId = id; document.getElementById('view-title').innerText = n; loadSongs(); loadPlaylists(); if(window.innerWidth <= 768) toggleSidebar(); closeCifraViewer(); }
    function editCifra(id, txt) { if(isGuest) return; currentSongId = id; document.getElementById('cifra-input').value = txt || ""; document.getElementById('cifra-modal').style.display = 'flex'; }
    function closeCifra() { document.getElementById('cifra-modal').style.display = 'none'; }
    async function saveCifra() { const txt = document.getElementById('cifra-input').value; if (!currentSongId) return; const { error } = await supabaseClient.from('musicas').update({ cifra: txt }).eq('id', currentSongId); if (error) alert("Crie a coluna 'cifra' no Supabase!"); else { closeCifra(); loadSongs(); } }
</script>
</body>
</html>
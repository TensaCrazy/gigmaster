<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIGMASTER PRO | v29.0</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root { --green:#1db954; --bg:#0b0b0b; --surface:#141414; --border:#2a2a2a; --text:#fff; }
*{box-sizing:border-box}
body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}

button{cursor:pointer;border:none;border-radius:10px}
.btn{background:var(--green);color:#fff;padding:12px;font-weight:600;width:100%;margin-bottom:12px}

#auth{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999}
.auth-box{width:320px;text-align:center}
.auth-box input{width:100%;padding:14px;margin-bottom:10px;border-radius:10px;background:#111;border:1px solid #333;color:#fff}

#app{display:none;flex-direction:column;height:100vh}
header{height:60px;display:flex;justify-content:space-between;align-items:center;padding:0 20px;border-bottom:1px solid var(--border);background:var(--surface)}
main{flex:1;display:flex}
aside{width:280px;border-right:1px solid var(--border);padding:15px}
section{flex:1;padding:20px;overflow:auto}
footer{height:140px;border-top:1px solid var(--border);padding:15px;background:var(--surface)}

.playlist{padding:12px;border-radius:10px;background:#1b1b1b;margin-bottom:8px}
.song{padding:12px;border-bottom:1px solid var(--border);cursor:pointer}

.controls{display:flex;justify-content:center;gap:20px;margin-top:10px}
.slider-box{display:flex;align-items:center;gap:8px;font-size:12px}

#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--green);padding:10px 20px;border-radius:20px;display:none;z-index:10000}
@media(max-width:768px){aside{display:none}}
</style>
</head>

<body>

<div id="toast"></div>

<!-- LOGIN -->
<div id="auth">
  <div class="auth-box">
    <h2 style="color:var(--green);letter-spacing:4px">GIGMASTER</h2>
    <input id="email" type="email" placeholder="Seu e-mail">
    <button class="btn" onclick="loginEmail()">ENTRAR / CRIAR CONTA</button>
    <button class="btn" style="background:#4285F4" onclick="loginGoogle()">GOOGLE</button>
    <p style="font-size:12px;color:#777">Login por link seguro</p>
  </div>
</div>

<!-- APP -->
<div id="app">
<header>
  <div>GIGMASTER <span style="color:var(--green)">PRO</span></div>
  <div onclick="logout()" style="cursor:pointer;font-size:12px">SAIR</div>
</header>

<main>
<aside>
  <button class="btn" onclick="addPlaylist()">+ NOVA PLAYLIST</button>
  <div id="playlists"></div>
</aside>

<section>
  <h2 id="pl-title">Biblioteca</h2>
  <input type="file" id="upload" hidden accept="audio/mp3">
  <button class="btn" id="btn-up" style="display:none;width:200px" onclick="upload.click()">IMPORTAR MP3</button>
  <div id="songs"></div>
</section>
</main>

<footer>
<div id="now" style="text-align:center;font-size:12px;color:var(--green)">Standby</div>
<input type="range" id="seek" min="0" step="0.01" value="0" style="width:100%">
<div class="controls">
  <div class="slider-box">
    <span>PITCH</span>
    <input id="p-slide" type="range" min="-7" max="7" value="0">
    <b id="p-val">0</b>
  </div>
  <button id="play" onclick="togglePlay()" style="width:50px;height:50px;border-radius:50%">â–¶</button>
  <div class="slider-box">
    <span>VOL</span>
    <input id="v-slide" type="range" min="-40" max="6" value="0">
  </div>
</div>
</footer>
</div>

<script>
const sb = supabase.createClient(
 "https://mdtqwugkaonipbfqqvhj.supabase.co",
 "sb_publishable_ercRd8vFjpnVyXf0WiPVSw_tWCSmsGm"
);

const auth = document.getElementById("auth");
const app = document.getElementById("app");

function toast(m){
 const t=document.getElementById("toast");
 t.innerText=m; t.style.display="block";
 setTimeout(()=>t.style.display="none",2000);
}

/* AUTH */
async function loginEmail(){
 const email=document.getElementById("email").value;
 if(!email) return alert("Digite um email");
 const {error}=await sb.auth.signInWithOtp({email});
 if(error) alert(error.message);
 else toast("Confira seu email ðŸ“©");
}

async function loginGoogle(){
 await sb.auth.signInWithOAuth({
  provider:"google",
  options:{redirectTo:location.origin+location.pathname}
 });
}

async function logout(){ await sb.auth.signOut(); }

sb.auth.onAuthStateChange((e,s)=>{
 if(s){ auth.style.display="none"; app.style.display="flex"; loadPlaylists(); }
 else{ auth.style.display="flex"; app.style.display="none"; }
});

/* PLAYER */
const player=new Tone.Player().toDestination();
const pitch=new Tone.PitchShift(0).toDestination();
let offset=0,last=0;

function togglePlay(){
 if(!player.buffer.loaded) return;
 Tone.start();
 if(player.state==="started"){
  offset+=Tone.now()-last; player.stop(); play.innerText="â–¶";
 }else{
  last=Tone.now(); player.start(0,offset); play.innerText="âšâš";
 }
}

/* PLAYLISTS */
async function loadPlaylists(){
 const {data:{user}}=await sb.auth.getUser();
 const {data}=await sb.from("playlists").select("*").eq("user_id",user.id);
 playlists.innerHTML=(data||[]).map(p=>`
  <div class="playlist" onclick="selectPlaylist(${p.id},'${p.nome}')">
   ${p.nome.toUpperCase()}
  </div>`).join("");
}

async function addPlaylist(){
 const nome=prompt("Nome da playlist:");
 if(!nome) return;
 const {data:{user}}=await sb.auth.getUser();
 await sb.from("playlists").insert([{nome,user_id:user.id}]);
 loadPlaylists();
}

let current=null;

async function selectPlaylist(id,n){
 current=id;
 pl-title.innerText=n;
 btn-up.style.display="block";
 loadSongs();
}

async function loadSongs(){
 const {data}=await sb.from("musicas").select("*").eq("playlist_id",current);
 songs.innerHTML=(data||[]).map(s=>`
  <div class="song" onclick="playSong('${s.audio_url}','${s.titulo}',${s.pitch})">
   ${s.titulo}
  </div>`).join("");
}

async function playSong(url,t,p){
 now.innerText="CARREGANDO...";
 player.stop();
 player.buffer=await new Tone.ToneAudioBuffer(url);
 pitch.pitch=p;
 player.connect(pitch);
 offset=0; last=Tone.now();
 seek.max=player.buffer.duration;
 player.start();
 now.innerText=t;
 play.innerText="âšâš";
}

p-slide.oninput=e=>{pitch.pitch=e.target.value;p-val.innerText=e.target.value};
v-slide.oninput=e=>Tone.Destination.volume.value=e.target.value;

upload.onchange=async e=>{
 const f=e.target.files[0];
 const path=`audios/${Date.now()}_${f.name}`;
 await sb.storage.from("audios").upload(path,f);
 const {data:{publicUrl}}=sb.storage.from("audios").getPublicUrl(path);
 await sb.from("musicas").insert([{titulo:f.name,audio_url:publicUrl,playlist_id:current,pitch:0}]);
 loadSongs(); toast("Upload OK");
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIGMASTER PRO | v29.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --green:#1db954; --bg:#0b0b0b; --surface:#141414; --border:#2a2a2a; --text:#fff; }
        *{box-sizing:border-box}
        body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
        button{cursor:pointer;border:none;border-radius:10px}
        .btn{background:var(--green);color:#fff;padding:12px;font-weight:600;width:100%;margin-bottom:12px}
        #auth{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999}
        .auth-box{width:320px;text-align:center}
        .auth-box input{width:100%;padding:14px;margin-bottom:10px;border-radius:10px;background:#111;border:1px solid #333;color:#fff}
        #app{display:none;flex-direction:column;height:100vh}
        header{height:60px;display:flex;justify-content:space-between;align-items:center;padding:0 20px;border-bottom:1px solid var(--border);background:var(--surface)}
        main{flex:1;display:flex;overflow:hidden}
        aside{width:280px;border-right:1px solid var(--border);padding:15px;overflow-y:auto}
        section{flex:1;padding:20px;overflow-y:auto}
        footer{height:140px;border-top:1px solid var(--border);padding:15px;background:var(--surface)}
        .playlist{padding:12px;border-radius:10px;background:#1b1b1b;margin-bottom:8px;cursor:pointer}
        .playlist.active{background:var(--green)}
        .pl-tools{display:flex;gap:10px;margin-top:5px;font-size:10px;opacity:0.6}
        .song{padding:12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between}
        .controls{display:flex;justify-content:center;gap:20px;margin-top:10px}
        .slider-box{display:flex;align-items:center;gap:8px;font-size:12px}
        #toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--green);padding:10px 20px;border-radius:20px;display:none;z-index:10000}
        @media(max-width:768px){aside{display:none}}
    </style>
</head>
<body>

<div id="toast"></div>

<div id="auth">
  <div class="auth-box">
    <h2 style="color:var(--green);letter-spacing:4px">GIGMASTER</h2>
    <input id="email-field" type="email" placeholder="Seu e-mail">
    <button class="btn" onclick="loginEmail()">ENTRAR / CRIAR CONTA</button>
    <button class="btn" style="background:#4285F4" onclick="loginGoogle()">GOOGLE</button>
    <p style="font-size:12px;color:#777">Enviaremos um link de acesso ao seu e-mail.</p>
  </div>
</div>

<div id="app">
<header>
  <div>GIGMASTER <span style="color:var(--green)">PRO</span></div>
  <div onclick="logout()" style="cursor:pointer;font-size:12px">SAIR</div>
</header>

<main>
<aside>
  <button class="btn" onclick="addPlaylist()">+ NOVA PASTA</button>
  <div id="playlist-container"></div>
</aside>

<section>
  <h2 id="pl-title">Biblioteca</h2>
  <input type="file" id="upload" hidden accept="audio/mp3">
  <button class="btn" id="btn-up" style="display:none;width:200px" onclick="upload.click()">IMPORTAR MP3</button>
  <div id="songs-container"></div>
</section>
</main>

<footer>
<div id="now" style="text-align:center;font-size:12px;color:var(--green)">Standby</div>
<input type="range" id="seek" min="0" step="0.01" value="0" style="width:100%">
<div class="controls">
  <div class="slider-box">
    <span>PITCH</span>
    <input id="p-slide" type="range" min="-7" max="7" value="0">
    <b id="p-val">0</b>
  </div>
  <button id="play-btn" onclick="togglePlay()" style="width:50px;height:50px;border-radius:50%;background:#fff">‚ñ∂</button>
  <div class="slider-box">
    <span>VOL</span>
    <input id="v-slide" type="range" min="-40" max="6" value="0">
  </div>
</div>
</footer>
</div>

<script>
const sb = supabase.createClient("https://mdtqwugkaonipbfqqvhj.supabase.co", "sb_publishable_ercRd8vFjpnVyXf0WiPVSw_tWCSmsGm");

/* AUDIO ENGINE - NO DUPLICATION - CLEAN SOUND */
const player = new Tone.Player();
const pitchNode = new Tone.PitchShift(0).toDestination();
let offset=0, lastStart=0, isDragging=false, curPl=null, curSongId=null;

function routeAudio(p) {
    player.disconnect();
    if (p == 0) player.toDestination(); // Som puro sem distor√ß√£o
    else { pitchNode.pitch = p; player.connect(pitchNode); }
}

/* AUTH */
async function loginEmail(){
    const email = document.getElementById("email-field").value;
    const {error} = await sb.auth.signInWithOtp({email});
    if(error) alert(error.message); else toast("Link enviado ao e-mail! üì©");
}
async function loginGoogle(){ await sb.auth.signInWithOAuth({ provider:"google" }); }
async function logout(){ await sb.auth.signOut(); location.reload(); }

sb.auth.onAuthStateChange((event, session) => {
    if(session) {
        document.getElementById("auth").style.display="none";
        document.getElementById("app").style.display="flex";
        loadPlaylists();
    }
});

/* PLAYLISTS & GEST√ÉO */
async function loadPlaylists(){
    const {data:{user}} = await sb.auth.getUser();
    const {data} = await sb.from("playlists").select("*").eq("user_id", user.id).order("nome");
    document.getElementById("playlist-container").innerHTML = (data||[]).map(p => `
        <div class="playlist ${curPl == p.id ? 'active' : ''}" onclick="selectPlaylist(${p.id},'${p.nome}')">
            ${p.nome.toUpperCase()}
            <div class="pl-tools">
                <span onclick="event.stopPropagation(); deletePlaylist(${p.id})">üóëÔ∏è EXCLUIR</span>
                <span onclick="event.stopPropagation(); downloadZip(${p.id},'${p.nome}')">üì¶ ZIP</span>
            </div>
        </div>`).join("");
}

async function selectPlaylist(id, n){
    curPl = id; document.getElementById("pl-title").innerText = n;
    document.getElementById("btn-up").style.display = "block";
    loadPlaylists(); loadSongs();
}

async function loadSongs(){
    const {data} = await sb.from("musicas").select("*").eq("playlist_id", curPl).order("titulo");
    document.getElementById("songs-container").innerHTML = (data||[]).map(s => `
        <div class="song" onclick="playSong('${s.audio_url}','${s.titulo}',${s.pitch},${s.id})">
            <span>${s.titulo}</span>
            <small onclick="event.stopPropagation(); deleteSong(${s.id})" style="opacity:0.4">‚úï</small>
        </div>`).join("");
}

/* PLAYBACK & SEEK */
async function playSong(url, t, p, id){
    curSongId = id; document.getElementById("now").innerText = "CARREGANDO...";
    player.stop();
    const res = await fetch(url);
    player.buffer = await new Tone.ToneAudioBuffer().load(URL.createObjectURL(await res.blob()));
    offset = 0; lastStart = Tone.now();
    routeAudio(p);
    document.getElementById("p-slide").value = p;
    document.getElementById("p-val").innerText = p;
    document.getElementById("seek").max = player.buffer.duration;
    player.start();
    document.getElementById("now").innerText = t;
    document.getElementById("play-btn").innerText = "‚ùö‚ùö";
}

function togglePlay(){
    if(!player.buffer.loaded) return;
    Tone.start();
    if(player.state === "started"){
        offset += Tone.now() - lastStart; player.stop();
        document.getElementById("play-btn").innerText = "‚ñ∂";
    }else{
        lastStart = Tone.now(); player.start(0, offset);
        document.getElementById("play-btn").innerText = "‚ùö‚ùö";
    }
}

document.getElementById("seek").onmousedown = () => isDragging = true;
document.getElementById("seek").onchange = e => {
    isDragging = false; offset = parseFloat(e.target.value);
    if(player.state === "started") { lastStart = Tone.now(); player.start(0, offset); }
};

setInterval(() => {
    if(player.state === "started" && !isDragging) {
        document.getElementById("seek").value = offset + (Tone.now() - lastStart);
    }
}, 100);

document.getElementById("p-slide").oninput = e => { 
    const v = parseInt(e.target.value);
    routeAudio(v); document.getElementById("p-val").innerText = v; 
};
document.getElementById("v-slide").oninput = e => Tone.Destination.volume.value = e.target.value;

/* GEST√ÉO AVAN√áADA */
async function deletePlaylist(id) {
    if(confirm("Excluir pasta e todas as m√∫sicas?")) {
        await sb.from("musicas").delete().eq("playlist_id", id);
        await sb.from("playlists").delete().eq("id", id);
        loadPlaylists();
    }
}

async function deleteSong(id) {
    await sb.from("musicas").delete().eq("id", id);
    loadSongs();
}

async function downloadZip(id, name) {
    toast("üì¶ Gerando ZIP...");
    const { data } = await sb.from('musicas').select('*').eq('playlist_id', id);
    const zip = new JSZip();
    for (const s of data) {
        const res = await fetch(s.audio_url);
        zip.file(s.titulo, await res.blob());
    }
    const content = await zip.generateAsync({type:"blob"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = `${name}.zip`; a.click();
}

upload.onchange = async e => {
    const f = e.target.files[0]; if(!f) return;
    toast("‚è≥ Enviando...");
    const path = `audios/${Date.now()}_${f.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase()}`;
    await sb.storage.from("audios").upload(path, f);
    const {data:{publicUrl}} = sb.storage.from("audios").getPublicUrl(path);
    await sb.from("musicas").insert([{titulo:f.name, audio_url:publicUrl, playlist_id:curPl, pitch:0}]);
    loadSongs(); toast("Upload Conclu√≠do!");
};

async function addPlaylist(){
    const n = prompt("Nome da Pasta:"); if(!n) return;
    const {data:{user}} = await sb.auth.getUser();
    await sb.from("playlists").insert([{nome:n, user_id:user.id}]);
    loadPlaylists();
}

function toast(m){
    const t=document.getElementById("toast");
    t.innerText=m; t.style.display="block";
    setTimeout(()=>t.style.display="none",2500);
}
</script>
</body>
</html>
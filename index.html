<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIGMASTER PRO | v29</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --green:#1db954; --bg:#0b0b0b; --surface:#141414;
  --border:#2a2a2a; --text:#fff;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter,sans-serif;
  background:var(--bg);color:var(--text);
  height:100vh;display:flex;flex-direction:column;
}

/* LOGIN */
#auth{
  position:fixed;inset:0;z-index:5000;
  display:flex;align-items:center;justify-content:center;
  background:#000;
}
.auth-box{width:320px;padding:20px;text-align:center}
.auth-box input{
  width:100%;padding:14px;margin-bottom:10px;
  border-radius:10px;border:1px solid #333;
  background:#111;color:#fff;
}

/* APP */
header{
  height:60px;padding:0 20px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);
  background:var(--surface);
}
main{flex:1;display:flex;overflow:hidden}
aside{
  width:260px;padding:15px;
  border-right:1px solid var(--border);
}
section{flex:1;padding:20px;overflow:auto}

button{
  border:none;border-radius:10px;
  cursor:pointer;font-weight:600;
}
.btn{
  width:100%;padding:12px;margin-bottom:12px;
  background:var(--green);color:#fff;
}

.playlist{
  padding:12px;margin-bottom:8px;
  background:#1b1b1b;border-radius:10px;
}
.playlist.active{border:1px solid var(--green)}

.song{
  padding:14px;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;
}

/* PLAYER */
footer{
  height:150px;padding:15px;
  border-top:1px solid var(--border);
  background:var(--surface);
}
.controls{
  display:flex;align-items:center;
  justify-content:center;gap:20px;
}
.slider{display:flex;align-items:center;gap:8px;font-size:12px}
input[type=range]{accent-color:var(--green)}

#toast{
  position:fixed;top:20px;left:50%;
  transform:translateX(-50%);
  background:var(--green);color:#fff;
  padding:10px 20px;border-radius:20px;
  display:none;z-index:9000;
}

@media(max-width:768px){ aside{display:none} }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="auth">
  <div class="auth-box">
    <h2 style="color:var(--green)">GIGMASTER</h2>
    <input id="email" type="email" placeholder="E-mail">
    <input id="pass" type="password" placeholder="Senha">
    <button class="btn" onclick="auth('in')">ENTRAR</button>
    <button class="btn" style="background:#4285F4" onclick="google()">GOOGLE</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;flex-direction:column;height:100vh">
<header>
  <div>GIGMASTER <span style="color:var(--green)">PRO</span></div>
  <div onclick="logout()" style="cursor:pointer">SAIR</div>
</header>

<main>
<aside>
  <button class="btn" onclick="newPlaylist()">+ PLAYLIST</button>
  <div id="playlists"></div>
</aside>

<section>
  <h2 id="pl-title">Biblioteca</h2>
  <input id="upload" type="file" hidden accept="audio/mp3">
  <button id="btn-up" class="btn" style="display:none;width:200px"
    onclick="upload.click()">+ IMPORTAR MP3</button>
  <div id="songs"></div>
</section>
</main>

<footer>
  <div id="now" style="text-align:center;color:var(--green)">Standby</div>
  <input id="seek" type="range" min="0" step="0.01" value="0" style="width:100%">
  <div class="controls">
    <div class="slider">
      PITCH <input id="pitch" type="range" min="-7" max="7" value="0">
      <b id="pval">0</b>
    </div>
    <button id="play" onclick="togglePlay()" style="width:50px;height:50px">▶</button>
    <div class="slider">
      VOL <input id="vol" type="range" min="-40" max="6" value="0">
    </div>
  </div>
</footer>
</div>

<div id="toast"></div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://mdtqwugkaonipbfqqvhj.supabase.co",
  "sb_publishable_ercRd8vFjpnVyXf0WiPVSw_tWCSmsGm"
);

/* PLAYER */
const player = new Tone.Player().toDestination();
const pitchFx = new Tone.PitchShift(0).toDestination();
let offset=0,last=0,drag=false,curPl=null;

/* AUDIO ROUTE */
function route(p){
  player.disconnect();
  if(p==0) player.toDestination();
  else{ pitchFx.pitch=p; player.connect(pitchFx); }
}

/* PLAY / PAUSE */
async function togglePlay(){
  await Tone.start();
  if(!player.buffer.loaded) return;
  if(player.state==="started"){
    offset+=Tone.now()-last;
    player.stop();
    play.textContent="▶";
  }else{
    last=Tone.now();
    player.start(0,offset);
    play.textContent="❚❚";
  }
}

/* AUTH */
async function auth(t){
  const email=femail.value, password=pass.value;
  const r=t=="in"?
    await sb.auth.signInWithPassword({email,password}):
    await sb.auth.signUp({email,password});
  if(r.error) alert(r.error.message); else init();
}
function google(){
  sb.auth.signInWithOAuth({provider:"google"});
}
async function init(){
  auth.style.display="none";
  app.style.display="flex";
  loadPlaylists();
}
async function logout(){await sb.auth.signOut();location.reload()}

/* PLAYLISTS */
async function newPlaylist(){
  const nome=prompt("Nome da playlist:");
  if(!nome) return;
  const {data:{user}}=await sb.auth.getUser();
  await sb.from("playlists").insert({nome,user_id:user.id});
  loadPlaylists();
}
async function loadPlaylists(){
  const {data:{user}}=await sb.auth.getUser();
  const {data}=await sb.from("playlists").select("*").eq("user_id",user.id);
  playlists.innerHTML=data.map(p=>`
    <div class="playlist ${curPl==p.id?'active':''}"
      onclick="selectPl(${p.id},'${p.nome}')">${p.nome}</div>`).join("");
}
function selectPl(id,n){
  curPl=id;pltitle.textContent=n;btn-up.style.display="block";
  loadPlaylists();loadSongs();
}

/* SONGS */
async function loadSongs(){
  const {data}=await sb.from("musicas").select("*")
    .eq("playlist_id",curPl).order("titulo");
  songs.innerHTML=data.map(s=>`
    <div class="song" onclick="playSong('${s.audio_url}','${s.titulo}',${s.pitch})">
      <span>${s.titulo}</span><small>${s.pitch} ST</small>
    </div>`).join("");
}
async function playSong(url,t,p){
  now.textContent="CARREGANDO...";
  player.stop();offset=0;
  player.buffer=await new Tone.ToneAudioBuffer(url);
  route(p);pitch.value=p;pval.textContent=p;
  seek.max=player.buffer.duration;
  now.textContent=t;
  last=Tone.now();player.start();play.textContent="❚❚";
}

/* CONTROLS */
pitch.oninput=e=>{pval.textContent=e.target.value;route(+e.target.value)}
vol.oninput=e=>Tone.Destination.volume.value=e.target.value;
seek.onmousedown=()=>drag=true;
seek.onchange=e=>{
  drag=false;offset=+e.target.value;
  if(player.state==="started"){last=Tone.now();player.start(0,offset)}
}
setInterval(()=>{
  if(player.state==="started"&&!drag)
    seek.value=offset+(Tone.now()-last);
},100);

/* UPLOAD */
upload.onchange=async e=>{
  const f=e.target.files[0];
  toastMsg("ENVIANDO...");
  const path=`audios/${Date.now()}_${f.name}`;
  await sb.storage.from("audios").upload(path,f);
  const {data:{publicUrl}}=sb.storage.from("audios").getPublicUrl(path);
  await sb.from("musicas").insert({
    titulo:f.name,audio_url:publicUrl,playlist_id:curPl,pitch:0
  });
  loadSongs();toastMsg("OK!");
}

/* TOAST */
function toastMsg(t){
  toast.textContent=t;toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2000);
}

/* INIT */
sb.auth.getSession().then(r=>r.data.session&&init());
</script>
</body>
</html>

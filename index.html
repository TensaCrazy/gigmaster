<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIGMASTER PRO | v29.9</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{--green:#1db954;--bg:#0b0b0b;--surface:#141414;--border:#2a2a2a;--text:#fff}
body.light{--green:#e91e63;--bg:#e0e0e0;--surface:#f5f5f5;--border:#ccc;--text:#111}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}

/* LOGIN */
#auth{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999}
.auth-box{width:320px;text-align:center}
.auth-box input{width:100%;padding:14px;margin-bottom:10px;border-radius:10px;background:#111;border:1px solid #333;color:#fff}

/* APP */
#app{display:none;flex-direction:column;height:100vh}
header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:var(--surface);border-bottom:1px solid var(--border)}

.u-badge{background:var(--border);padding:6px 14px;border-radius:20px;font-size:11px;cursor:pointer;position:relative}
.drop-menu{display:none;position:absolute;top:45px;right:0;width:200px;background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;z-index:600}
.drop-menu div{padding:14px 18px;font-size:11px;border-bottom:1px solid var(--border);cursor:pointer}

main{flex:1;display:flex;overflow:hidden}
aside{width:280px;border-right:1px solid var(--border);padding:15px;overflow-y:auto;background:var(--bg)}
section{flex:1;padding:20px;overflow-y:auto}

button{cursor:pointer;border:none;border-radius:10px}
.btn{background:var(--green);color:#fff;padding:12px;font-weight:600;width:100%;margin-bottom:12px}

.playlist{padding:12px;border-radius:10px;background:#1b1b1b;margin-bottom:8px;cursor:pointer;border:1px solid transparent}
.playlist.active{background:var(--green);border-color:rgba(255,255,255,0.2)}
.pl-tools{display:flex;gap:12px;margin-top:8px;font-size:10px;opacity:.7;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px}

.song{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;cursor:pointer}

footer{height:140px;border-top:1px solid var(--border);padding:15px;background:var(--surface)}
.controls{display:flex;justify-content:center;gap:20px;margin-top:10px}
.slider-box{display:flex;align-items:center;gap:8px;font-size:12px}

#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--green);padding:10px 20px;border-radius:20px;display:none;z-index:99999}
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items:center; justify-content:center; backdrop-filter: blur(8px); }

@media(max-width:768px){aside{display:none}}
</style>
</head>
<body onclick="Tone.start()">

<div id="toast"></div>

<div id="auth">
  <div class="auth-box">
    <h2 style="color:var(--green);letter-spacing:4px">GIGMASTER</h2>
    <input id="email" type="email" placeholder="E-mail">
    <input id="pass" type="password" placeholder="Senha">
    <button class="btn" onclick="handleAuth('in')">ENTRAR</button>
    <button class="btn" style="background:#4285F4" onclick="loginGoogle()">GOOGLE</button>
    <p style="font-size:11px;color:#777;cursor:pointer" onclick="handleAuth('up')">Criar conta</p>
  </div>
</div>

<div id="modal-pix" class="modal-overlay" onclick="closeM('modal-pix')">
  <div class="modal-box" style="background:var(--surface);padding:30px;border-radius:24px;text-align:center;" onclick="event.stopPropagation()">
    <h3 style="margin-top:0">APOIAR VIA PIX</h3>
    <img src="pix.jpg" style="width:100%; border-radius:15px; margin:10px 0;">
    <button class="btn" onclick="closeM('modal-pix')">FECHAR</button>
  </div>
</div>

<div id="app">
<header>
  <div>GIGMASTER <span style="color:var(--green)">PRO</span></div>
  <div class="u-badge" onclick="toggleMenu()">
    <span id="u-display">PERFIL</span> ‚ñº
    <div class="drop-menu" id="u-drop">
      <div onclick="toggleTheme()">üåì TEMA</div>
      <div onclick="uiRenameNick()">üë§ NICKNAME</div>
      <div onclick="toast('Bug relatado!')">üêû RELATAR BUG</div>
      <div onclick="openM('modal-pix')">üíé APOIAR PIX</div>
      <div onclick="logout()" style="color:#ff4d4d">üö™ SAIR</div>
    </div>
  </div>
</header>

<main>
<aside>
  <button class="btn" onclick="addPlaylist()">+ NOVA PASTA</button>
  <div id="playlist-container"></div>
</aside>
<section>
  <h2 id="pl-title">Biblioteca</h2>
  <input type="file" id="upload" hidden accept="audio/mp3">
  <button class="btn" id="btn-up" style="display:none;width:200px" onclick="upload.click()">IMPORTAR MP3</button>
  <div id="songs-container"></div>
</section>
</main>

<footer>
<div id="now" style="text-align:center;font-size:12px;color:var(--green)">Standby</div>
<input type="range" id="seek" min="0" step="0.01" value="0" style="width:100%">
<div class="controls">
  <div class="slider-box">
    <span>PITCH</span>
    <input id="p-slide" type="range" min="-7" max="7" value="0">
    <b id="p-val">0</b>
  </div>
  <button id="play-btn" onclick="togglePlay()" style="width:50px;height:50px;border-radius:50%;background:#fff;color:#000;font-size:20px">‚ñ∂</button>
  <div class="slider-box">
    <span>VOL</span>
    <input id="v-slide" type="range" min="-40" max="6" value="0">
  </div>
</div>
</footer>
</div>

<script>
const sb = supabase.createClient("https://mdtqwugkaonipbfqqvhj.supabase.co", "sb_publishable_ercRd8vFjpnVyXf0WiPVSw_tWCSmsGm");

const player=new Tone.Player();
const pitchNode=new Tone.PitchShift(0).toDestination();
let offset=0, lastStart=0, dragging=false, curPl=null;

/* AUTH */
async function handleAuth(type){
  const email=document.getElementById("email").value, pass=document.getElementById("pass").value;
  const {error} = type==="in" ? await sb.auth.signInWithPassword({email,password:pass}) : await sb.auth.signUp({email,password:pass});
  if(error) alert(error.message);
}
async function loginGoogle(){ await sb.auth.signInWithOAuth({ provider:"google", options:{ redirectTo: window.location.origin + window.location.pathname } }); }
async function logout(){ await sb.auth.signOut(); location.reload(); }

/* CARREGAMENTO ROBUSTO */
sb.auth.onAuthStateChange(async (e,session)=>{
  if(session){
    document.getElementById("auth").style.display="none";
    document.getElementById("app").style.display="flex";
    
    // Pegar Perfil
    const {data:prof} = await sb.from('profiles').select('username').eq('id', session.user.id).single();
    document.getElementById("u-display").innerText = (prof?.username || session.user.email.split("@")[0]).toUpperCase();
    
    // Tenta carregar playlists 3 vezes se falhar
    let tentativas = 0;
    const interval = setInterval(async () => {
        const ok = await loadPlaylists();
        tentativas++;
        if(ok || tentativas > 3) clearInterval(interval);
    }, 500);

  } else {
    document.getElementById("auth").style.display="flex";
    document.getElementById("app").style.display="none";
  }
});

/* PLAYLISTS */
async function loadPlaylists(){
  const {data:{user}} = await sb.auth.getUser();
  if(!user) return false;
  
  const {data, error} = await sb.from("playlists").select("*").eq("user_id",user.id).order("nome");
  if(error) return false;

  const container = document.getElementById("playlist-container");
  container.innerHTML = (data || []).map(p => `
    <div class="playlist ${curPl == p.id ? 'active' : ''}" onclick="selectPlaylist(${p.id},'${p.nome}')">
      <b>${p.nome.toUpperCase()}</b>
      <div class="pl-tools">
        <span onclick="event.stopPropagation(); downloadZip(${p.id},'${p.nome}')">üì¶ ZIP</span>
        <span onclick="event.stopPropagation(); deletePlaylist(${p.id})">üóëÔ∏è EXCLUIR</span>
      </div>
    </div>`).join("");
  return true;
}

/* AUDIO & SONGS */
function routeAudio(p){ player.disconnect(); p==0?player.toDestination():(pitchNode.pitch=p,player.connect(pitchNode)); }

async function playSong(url,t,p){
  document.getElementById("now").innerText="CARREGANDO...";
  player.stop();
  const res=await fetch(url);
  player.buffer=await new Tone.ToneAudioBuffer().load(URL.createObjectURL(await res.blob()));
  routeAudio(p); offset=0; lastStart=Tone.now();
  document.getElementById("p-slide").value=p;
  document.getElementById("p-val").innerText=p;
  document.getElementById("seek").max=player.buffer.duration;
  player.start();
  document.getElementById("now").innerText=t;
  document.getElementById("play-btn").innerText="‚ùö‚ùö";
}

function togglePlay(){
  if(!player.buffer?.loaded)return;
  Tone.start();
  if(player.state==="started"){
    offset+=Tone.now()-lastStart; player.stop();
    document.getElementById("play-btn").innerText="‚ñ∂";
  }else{
    lastStart=Tone.now(); player.start(0,offset);
    document.getElementById("play-btn").innerText="‚ùö‚ùö";
  }
}

const sk=document.getElementById("seek");
sk.onmousedown = sk.ontouchstart = () => dragging=true;
sk.onchange = e => {
    dragging=false; offset=parseFloat(e.target.value);
    if(player.state==="started"){ lastStart=Tone.now(); player.start(0, offset); }
};
setInterval(()=>{ if(player.state==="started" && !dragging) sk.value=offset+(Tone.now()-lastStart); }, 100);

document.getElementById("p-slide").oninput = e => { routeAudio(parseInt(e.target.value)); document.getElementById("p-val").innerText=e.target.value; };
document.getElementById("v-slide").oninput = e => Tone.Destination.volume.value = e.target.value;

async function selectPlaylist(id,n){ curPl=id; document.getElementById("pl-title").innerText=n; document.getElementById("btn-up").style.display="block"; loadSongs(); loadPlaylists(); }

async function loadSongs(){
  const {data}=await sb.from("musicas").select("*").eq("playlist_id",curPl).order("titulo");
  document.getElementById("songs-container").innerHTML=(data||[]).map(s => `
    <div class="song" onclick="playSong('${s.audio_url}','${s.titulo}',${s.pitch})">
      <span>${s.titulo}</span>
      <div class="song-actions" style="display:flex; gap:15px;">
        <svg onclick="event.stopPropagation(); downloadDirect('${s.audio_url}', '${s.titulo}')" viewBox="0 0 24 24" width="18" fill="currentColor" style="opacity:0.6"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        <span onclick="event.stopPropagation(); deleteSong(${s.id})" style="opacity:.4">‚úï</span>
      </div>
    </div>`).join("");
}

/* MENUS & GEST√ÉO */
function openM(id) { document.getElementById(id).style.display = 'flex'; }
function closeM(id) { document.getElementById(id).style.display = 'none'; }
function toggleMenu(){ const m=document.getElementById("u-drop"); m.style.display=m.style.display==="block"?"none":"block"; }
function toggleTheme(){ document.body.classList.toggle("light") }
function toast(t){ const x=document.getElementById("toast"); x.innerText=t; x.style.display="block"; setTimeout(()=>x.style.display="none",3000) }

async function addPlaylist(){
  const n=prompt("Nome da pasta:"); if(!n)return;
  const {data:{user}}=await sb.auth.getUser();
  await sb.from("playlists").insert([{nome:n,user_id:user.id}]); loadPlaylists();
}
async function deletePlaylist(id){ if(confirm("Apagar pasta?")) { await sb.from("musicas").delete().eq("playlist_id",id); await sb.from("playlists").delete().eq("id",id); loadPlaylists(); } }
async function deleteSong(id){ await sb.from("musicas").delete().eq("id",id); loadSongs(); }

async function downloadDirect(url, filename) {
    const res = await fetch(url);
    const blob = await res.blob();
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

async function downloadZip(id, name) {
    toast("üì¶ Gerando ZIP...");
    const { data } = await sb.from('musicas').select('*').eq('playlist_id', id);
    const zip = new JSZip();
    for (const s of data) {
        const res = await fetch(s.audio_url);
        zip.file(s.titulo, await res.blob());
    }
    const content = await zip.generateAsync({type:"blob"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = `${name}.zip`; a.click();
}

async function uiRenameNick() {
    const n = prompt("Novo Nickname:"); if(!n) return;
    const {data:{user}} = await sb.auth.getUser();
    await sb.from('profiles').upsert({id: user.id, username: n});
    document.getElementById("u-display").innerText = n.toUpperCase();
}

upload.onchange=async e=>{
  const f=e.target.files[0]; if(!f)return;
  toast("‚è≥ Enviando...");
  const path=`audios/${Date.now()}_${f.name}`;
  await sb.storage.from("audios").upload(path,f);
  const {data: {publicUrl}} = sb.storage.from("audios").getPublicUrl(path);
  await sb.from("musicas").insert([{titulo:f.name,audio_url:publicUrl,playlist_id:curPl,pitch:0}]);
  loadSongs(); toast("OK!");
};
</script>
</body>
</html>